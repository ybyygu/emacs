#+TITLE: Emacs 配置 (based on spacemacs)
#+SETUPFILE: ~/Notes/common.org
#+SETUPFILE: ~/Notes/latex.org
#+STARTUP: indent
# Created: 2016-10-14 14:20

* Memo [1/1]
** [2017-10-07 Sat] 解决org-mode中M-RET键绑定的问题
在keybindings.el处加一行即可:
: (org-defkey org-mode-map [(meta return)] 'org-meta-return)
- https://github.com/syl20bnr/spacemacs/issues/9603
** [2017-10-06 Fri] 解决字体高清屏HiDPI字体显示太小的问题
在字体设置处, 注释掉:size行即可. [[https://github.com/syl20bnr/spacemacs/issues/6005][issue]]
** [2017-10-06 Fri] 解决org-mode加载大文件太慢的问题
- [2017-10-07 Sat] 发现是hl-todo这个包导致的问题. 禁用该包即可.
- [2017-10-06 Fri] 使用配置, 使用spacemacs-base distrubtion即可.
** [2017-09-27 Wed] 参考github上grettke的literate programming相关设置 [[https://github.com/grettke/help/blob/master/Org-Mode_Fundamentals.org][URL]]
优化设置, 方便在导出的代码中利用org-babel-tangle-jump-to-org函数跳转到原文件.
** [2017-09-24 Sun] 使用deepin-screenshot替代shutter
1. shutter依赖的perl包太多
2. archlinux最近的更新导致很多perl包得手动build
3. deepin-screenshot的软件功能比shutter更强大, 依赖更少.

其它可用的截图工具: https://wiki.archlinux.org/index.php/taking_a_screenshot

** [2017-09-20 Wed] 添加zotero链接, 方便在org-mode或导出的pdf,html文件中打开zotero条目.
** [2017-09-07 Thu] 解决org-babel无法执行source block的问题
报错: Evaluation of this python code block is disabled.

解决:
1. 执行spacemacs/recomplie-elpa
2. 然后重启spacemacs

参考： [[https://github.com/syl20bnr/spacemacs/issues/7641][syl20bnr/spacemacs#7641]]

https://github.com/syl20bnr/spacemacs/issues/7641
** [2017-08-10 Thu] 升级chinese-fonts-setup至cnfonts
** [2016-12-23 Fri] 几个看着顺眼的theme
1. https://github.com/nashamri/spacemacs-theme
2. https://github.com/bbatsov/zenburn-emacs
3. https://github.com/cpaulik/emacs-material-theme

Tips:
1. theme可以直接在dotspacemacs设置, 重启后自动安装生效.
2. 使用theming layer可以很方便的修改配色.

** [2016-12-17 Sat] 修改ctrl-a和ctrl-e按键, 使之更接近emacs模式
** [2016-12-16 Fri] 添加快捷键SPC oz, 方便打开zotero附件
[2017-09-20 Wed] 使用zotero 5 standalone版本以后, zotero链接不能正常打开了. 改用更简单的设置.
** [2016-12-14 Wed] 以后要多参考Michael Lockhart的配置 [[https://github.com/sinewalker/dotspacemacs][URL]]
** [2016-12-13 Tue] 在doc-view buffer中一样可以使用SPC fj和SPC fo的功能来调用外部程序
** DONE [2016-12-12 Mon] 需要改进org-babel几个相关功能
CLOSED: [2016-12-23 Fri 15:38]
1. org-src-window-setup
2. org-edit-src自动保存
** [2016-12-11 Sun] pdf-tools神器 [[https://github.com/politza/pdf-toolsU][URL]]
** [2016-12-11 Sun] 添加快捷键 快速导出org-babel代码块.
: SPC ob
** [2016-12-10 Sat] 启用deft layer, 使用deft来搜索笔记
: SPC a n

** [2016-12-10 Sat] 禁用选中的文字进入clipboard的功能 [[https://github.com/syl20bnr/spacemacs/blob/master/doc/FAQ.org#prevent-the-visual-selection-overriding-my-system-clipboard][URL]]
: ;; Prevent the visual selection overriding my system clipboard
: (fset 'evil-visual-update-x-selection 'ignore)
** [2016-12-10 Sat] 修改spacemacs中默认的undo行为 默认的undo太变态了
: (setq evil-want-fine-undo t)
** [2016-12-06 Tue] 修改 spacemacs-theme 中的变量 禁用 org-mode 标题行字体缩放
: (setq spacemacs-theme-org-heigh nil)
** [2016-12-06 Tue] 为了能使中英文同时缩放修改 chinese-fonts-setup
: (setq cfs-use-face-font-rescale (eq system-type 'gnu/linux))

** [2016-12-06 Tue] 使用 chinese layer 中的 fcitx 包, 方便中英文切换. 同时使用 pangu-spacing
** [2016-12-04 Sun] 启用 colors layer 配色更醒目
** [2016-12-04 Sun] python 环境下启用 ipython
: SPC m s i,
** [2016-10-23 Sun] 以后可以研究下 Kitchin 的 scimax, 将他的配置集成进来 [[https://github.com/jkitchin/scimax][URL]]
** [2016-10-17 Mon] 大致成了 以后多花点时间学习下 spacemacs 的命令[[http://spacemacs.org/doc/DOCUMENTATION.html#commands][ URL]]
1. 删除空格: SPC x d w
2. 字数统计: SPC x c
3. 对齐符号: SPC x a =, ... 按 "="对齐行
4. 段落居口: SPC x j c justification
5. 大小写 : SPC x u, SPC x U
6. 扩选   : SPC v SPC V (也可用来替换以前的 iedit 编译功能)
7. narrow: SPC n r, SPC n w
8. 注释:  SPC c l, SPC c y (注释并复制一行, 有用)
9. 打开 buffer 对应的文件: SPC f j
10. 删除 buffer 对应的文件: SPC f D
11. locate: SPC f L (真方便)
12. 保存文件: SPC fs
13. 书签功能: SPC f b 书签界面可以添加删除书签
14. 默认支持自动保存
15. 搜索 SPC s s Helm-swoop 太威武了
16. 最近访问的文件: SPC f r, 当前目录下(project) SPC p r
17. 查词: z=, ispell-word
18. auto pair: SPC t p

| ~SPC f C d~ | convert file from unix to dos encoding                                                                                          |
| ~SPC f C u~ | convert file from dos to unix encoding                                                                                          |
| ~SPC f D~   | delete a file and the associated buffer (ask for confirmation)                           https://emacs.stackexchange.com/questions/19880/font-size-control-of-latex-previews-in-org-files                                       |
| ~SPC f E~   | open a file with elevated privileges (sudo edit)                                                                                |
| ~SPC f f~   | open file with =helm=                                                                                                           |
| ~SPC f F~   | try to open the file under point =helm=                                                                                         |
| ~SPC f j~   | jump to the current buffer file in dired                                                                                        |
| ~SPC f L~   | Locate a file (using =locate=)                                                                                                  |
| ~SPC f o~   | open a file using the default external program                                                                                  |
| ~SPC f R~   | rename the current file                                                                                                         |
| ~SPC f r~   | open a recent file with =helm=                                                                                                  |
| ~SPC f t~   | toggle file tree side bar using [[https://github.com/jaypei/emacs-neotree][NeoTree]]                                                                                         |
| ~SPC f v f~ | add a local variable to the current file                                                                                        |
| ~SPC f y~   | show and copy current file absolute path in the minibuffer                                                                      |
| ~SPC f e d~ | open the spacemacs dotfile (=~/.spacemacs=)                     |
| ~SPC f e D~ | open =ediff= buffer of =~/.spacemacs= and =.spacemacs.template= |
| ~SPC f e R~ | resync the dotfile with spacemacs                               |

**** Browsing files with Helm
| ~C-h~       | go up one level (parent directory |
| ~C-l~       | enter current directory           |
** [2016-10-17 Mon] 使用 use-package 来加载包 [[https://github.com/jwiegley/use-package][URL]]
** [2016-10-16 Sun] 可参考 Purcell 的配置: [[https://github.com/purcell/emacs.d][URL]]
** [2016-10-16 Sun] 中文字体的设置问题
*** 单独设 org-table [[https://emacs-china.org/t/org-mode/440/10][URL]]
#+name: 23a85e97-0652-4b09-937b-d994c5928afe
#+BEGIN_SRC elisp
     (custom-set-faces
      ;; custom-set-faces was added by Custom.
      ;; If you edit it by hand, you could mess it up, so be careful.
      ;; Your init file should contain only one such instance.
      ;; If there is more than one, they won't work right.
      '(org-table ((t (:foreground "#6c71c4" :family "Ubuntu Mono")))))
#+END_SRC
*** 使用 chinese-fonts-setup
#+name: c1c6cdc3-17a5-4e44-88a2-05bf525250fb
#+BEGIN_SRC elisp
  (use-package chinese-fonts-setup)
  (chinese-fonts-setup-enable)
  (cfs-set-spacemacs-fallback-fonts)
#+END_SRC

*** 基于 chinese layer
: (spacemacs//set-monospaced-font  "Monaco" "WenQuanYi Micro Hei Mono" 14 16)

问题: 视图缩放时中英不同步.

** [2016-10-15 Sat] spacemacs 设置修改方案
参考这里: [[https://github.com/ale-batt/dotspacemacs][URL]]

1. 修改.spacemacs 中的 user-config 函数, 从 gwp.org 文件中读取设置
   : (with-eval-after-load 'org (org-babel-load-file "~/Install/configs/spacemacs/config.org"))
   或者:
   : (with-eval-after-load 'org (load-file "~/Install/configs/spacemacs/config.el"))
** [2016-10-14 Fri] emacs24-starter-kit 更新维护不是很活跃. 现在已是 emacs25 时代了. 考虑换到 spacemacs
* text
:PROPERTIES:
:header-args: :noweb-ref init-text
:END:
** 常规操作
1. mark: C-@, C-M-SPC
2. goto-line

#+name: 85ccc98a-549e-42b1-a13c-a181c211a3c7
#+BEGIN_SRC emacs-lisp
  (global-set-key "\C-l" 'goto-line) ; [Ctrl]-[L]

  ;; more convenient than C-M-BACKSPC
  ;; (global-set-key (kbd "<f5> k") 'kill-whole-line)
  ;; (global-set-key (kbd  "M-k") 'kill-whole-line)
  ;; (global-set-key (kbd  "M-K") 'kill-sentence)

#+END_SRC

** 快速插入日期
#+name: cbbe7586-555e-4bab-b3db-390bcba518d8
#+BEGIN_SRC emacs-lisp
  (defun gwp/insert-date (arg)
    "Insert date at point. With prefix argument, insert date and time."
    (interactive "P")
    (insert (format-time-string "%Y-%m-%d"))
    (when arg
      (insert (format-time-string " %H:%M"))
      )
    )

  ;; C-c i calls insert-date-string
  (global-set-key (kbd "C-c i") 'gwp/insert-date)
#+END_SRC
** 快捷插入
#+name: 2684192d-ba8b-4196-8adc-157664e6c0f5
#+BEGIN_SRC emacs-lisp
  ;; referred: http://docs.huihoo.com/homepage/shredderyin/wiki/KeyBinding.html
  (define-prefix-command 'semicolon-map)
  (global-set-key (kbd ";") 'semicolon-map)
  (define-key semicolon-map (kbd "t") 'insert-true)
  (define-key semicolon-map (kbd "T") 'insert-todo)
  (define-key semicolon-map (kbd ";") 'insert-self)
  (define-key semicolon-map (kbd "<SPC>") 'insert-self-space)
  (define-key semicolon-map (kbd "f") 'insert-false)
  (define-key semicolon-map (kbd "F") 'insert-fixme)
  (define-key semicolon-map (kbd "n") 'insert-none)
  (define-key semicolon-map (kbd "{") 'insert-folding-start)
  (define-key semicolon-map (kbd "}") 'insert-folding-end)

  (defun insert-folding-start ()
    (interactive)
    (insert "# {{{")
  )

  (defun insert-folding-end ()
    (interactive)
    (insert "# }}}")
  )

  (defun insert-self ()
    (interactive)
    (insert ";")
  )

  (defun insert-self-space ()
    (interactive)
    (insert "; ")
  )

  (defun insert-none ()
    (interactive)
    (insert "None")
  )

  (defun insert-true ()
    (interactive)
    (insert "True")
  )

  (defun insert-todo ()
    (interactive)
    (insert "TODO: ")
  )

  (defun insert-false ()
    (interactive)
    (insert "False")
  )

  (defun insert-fixme ()
    (interactive)
    (insert "FIXME: ")
  )

#+END_SRC

** 处理空格
: SPC xdw 删除行尾空格.

#+name: 147c3a14-9b83-458c-a016-1d8ad07a3477
#+BEGIN_SRC emacs-lisp
  (setq show-trailing-whitespace t)
  (global-set-key (kbd "<f5> SPC") 'delete-trailing-whitespace)
  ;; make sure this always work
  (global-set-key (kbd "C-x C-o") 'delete-blank-lines)
#+END_SRC

** 按行或段移动
: [ e move line up
: ] e move line down

#+name: e6587a14-89c7-410e-9fd2-de4cdb455092
#+BEGIN_SRC emacs-lisp
  (defun move-text-internal (arg)
     (cond
      ((and mark-active transient-mark-mode)
       (if (> (point) (mark))
          (exchange-point-and-mark))
       (let ((column (current-column))
            (text (delete-and-extract-region (point) (mark))))
         (forward-line arg)
         (move-to-column column t)
         (set-mark (point))
         (insert text)
         (exchange-point-and-mark)
         (setq deactivate-mark nil)))
      (t
       (beginning-of-line)
       (when (or (> arg 0) (not (bobp)))
         (forward-line)
         (when (or (< arg 0) (not (eobp)))
          (transpose-lines arg))
         (forward-line -1)))))

  (defun move-text-down (arg)
     "Move region (transient-mark-mode active) or current line
    arg lines down."
     (interactive "*p")
     (move-text-internal arg))

  (defun move-text-up (arg)
     "Move region (transient-mark-mode active) or current line
    arg lines up."
     (interactive "*p")
     (move-text-internal (- arg))
     )

  (defun move-paragraph-down (arg)
     "Move current paragraph down."
     (interactive "*p")
     (transpose-paragraphs arg)
     (backward-paragraph arg)
     (forward-char))

  (defun move-paragraph-up (arg)
     "Move current paragraph down."
     (interactive "*p")
     (transpose-paragraphs (- arg))
     (backward-paragraph arg)
     (forward-char))

#+END_SRC
** 符号对操作
*** smart-parens [[https://github.com/Fuco1/smartparens][URL]]
比想像中的强大的多, 完全可以代替之前的设置.
1. 可以一对对的插入或删除
2. 可以在 region 里插入括号. 在 insert-mode 下选择区域, 按括号即可.

使用方法可以参考这里: [[https://ebzzry.github.io/emacs-pairs.html][URL]]
*** 旧的配置代码
#+name: 79f82ed2-7a3f-4077-8578-8034f2e3f015
#+BEGIN_SRC emacs-lisp

  (defvar my-skeleton-pair-alist
    '((?\) . ?\()
      (?\] . ?\[)
      (?} . ?{)
      ;; (?> . ?<)
      (?" . ?")))

  (defun my-skeleton-pair-end (arg)
    "Skip the char if it is an ending, otherwise insert it."
    (interactive "*p")
    (let ((char last-command-char))
      (if (and (assq char my-skeleton-pair-alist)
               (eq char (following-char)))
          (forward-char)
        (self-insert-command (prefix-numeric-value arg)))))


  (global-set-key (kbd "<f5> (") 'insert-pair)
  (global-set-key (kbd "<f5> <") 'insert-pair)
  (global-set-key (kbd "<f5> [") 'insert-pair)
  (global-set-key (kbd "<f5> {") 'insert-pair)
  (global-set-key (kbd "<f5> \"") 'insert-pair)
  (global-set-key (kbd "<f5> '") 'insert-pair)
  (global-set-key (kbd "<f5> C-d") 'delete-pair)
  ;; do not insert spaces
  ;; (setq parens-require-spaces nil)

  ;; http://www.emacswiki.org/emacs/ParenthesesAppearance
  ;; (show-paren-mode t)

  ;; enable electric pair by default
  ;; (setq electric-pair-mode t)

#+END_SRC

#+RESULTS:
: t

** 自动扩选
#+name: cb6f8678-3bf5-44b4-a0c2-c3a1b86a6245
#+BEGIN_SRC emacs-lisp
  ;; http://xahlee.org/emacs/modernization_mark-word.html
  ;; by Nikolaj Schumacher, 2008-10-20. Released under GPL.
  (defun semnav-up (arg)
    (interactive "p")
    (when (nth 3 (syntax-ppss))
      (if (> arg 0)
          (progn
            (skip-syntax-forward "^\"")
            (goto-char (1+ (point)))
            (decf arg))
        (skip-syntax-backward "^\"")
        (goto-char (1- (point)))
        (incf arg)))
    (up-list arg))

  ;; by Nikolaj Schumacher, 2008-10-20. Released under GPL.
  (defun extend-selection (arg &optional incremental)
    "Select the current word.
  Subsequent calls expands the selection to larger semantic unit."
    (interactive (list (prefix-numeric-value current-prefix-arg)
                       (or (and transient-mark-mode mark-active)
                           (eq last-command this-command))))
    (if incremental
        (progn
          (semnav-up (- arg))
          (forward-sexp)
          (mark-sexp -1))
      (if (> arg 1)
          (extend-selection (1- arg) t)
        (if (looking-at "\\=\\(\\s_\\|\\sw\\)*\\_>")
            (goto-char (match-end 0))
          (unless (memq (char-before) '(?\) ?\"))
            (forward-sexp)))
        (mark-sexp -1))))

  (global-set-key (kbd "M-8") 'extend-selection)

  (defun select-text-in-quote ()
  "Select text between the nearest left and right delimiters.
  Delimiters are paired characters: ()[]<>«»“”‘’「」, including \"\"."
   (interactive)
   (let (b1 b2)
     (skip-chars-backward "^<>(“{[「«\"‘")
     (setq b1 (point))
     (skip-chars-forward "^<>)”}]」»\"’")
     (setq b2 (point))
     (set-mark b1)
     )
   )

  (defun select-none-blank-text ()
  "Select none blank chars near the point in current line"
   (interactive)
   (let (b1 b2)
     (skip-chars-backward "^ \n")
     (setq b1 (point))
     (skip-chars-forward "^ \n")
     (setq b2 (point))
     (set-mark b1)
     )
   )

  (defun select-word ()
  "Select none blank chars near the point in current line"
   (interactive)
   (let (b1 b2)
     (backward-word)
     (setq b1 (point))
     (forward-word)
     (setq b2 (point))
     (set-mark b1)
     )
   )

  (defun select-line ()
  "Select current line"
   (interactive)
   (let (b1 b2)
     (move-beginning-of-line nil)
     (setq b1 (point))
     (move-end-of-line nil)
     (setq b2 (point))
     (set-mark b1)
     )
   )

  ;; (global-set-key (kbd "M-*") 'select-text-in-quote)
  ;; (global-set-key (kbd "M-4") 'select-word)
  (global-set-key (kbd "M-5") 'select-none-blank-text)
  ;; (global-set-key (kbd "M-6") 'select-line)

  ;; https://github.com/magnars/expand-region.el
  (starter-kit-install-if-needed 'expand-region)
  (require 'expand-region)
  (global-set-key (kbd "M-4") 'er/expand-region)

#+END_SRC

** 同时编辑多处文本
*** old config
#+name: 8ac9b8bd-0ccb-4bb6-89a6-914381c0f406
#+BEGIN_SRC emacs-lisp
  (starter-kit-install-if-needed 'iedit)
  (require 'iedit)
  (define-key global-map (kbd "C-;") 'iedit-mode)
  ;; disable flyspell mode for the annoying conflicting key bindings
  (flyspell-mode 0)
#+END_SRC

** goto-last-change
*** 如果需要先安装下.

#+name: 1dbc4a26-174b-4ebd-ba80-1f6066815d1b
#+BEGIN_SRC emacs-lisp
(starter-kit-install-if-needed 'goto-last-change)
#+END_SRC

#+RESULTS:
*** 设置快捷键
#+name: bf562780-7ae5-49b1-ae33-3c8b18a73221
#+BEGIN_SRC emacs-lisp
(require 'goto-last-change)
(global-set-key (kbd "<f5> b") 'goto-last-change)
#+END_SRC

#+RESULTS:
: goto-last-change

** gjf-mode: 编译 gaussian GJF 文件
#+name: da044c86-580b-4341-aa69-6331911d2969
#+BEGIN_SRC emacs-lisp
(require 'gjf-mode)
#+END_SRC

#+RESULTS:
: gjf-mode

* ui
:PROPERTIES:
:header-args: :noweb-ref init-ui
:END:
** 语言字体
中文问题相关 [[https://github.com/hick/emacs-chinese][URL]]

#+name: 371dccb7-b33d-4674-8e09-64fa1d9806ab
#+begin_src emacs-lisp
  (set-language-environment "UTF-8")
  (prefer-coding-system 'utf-8)
  (global-font-lock-mode t)

  ;; force a syntax-highlighting refresh
  (global-set-key (kbd "<f5> <f5>") 'font-lock-fontify-buffer)
  (auto-image-file-mode t)              ; View images inside Emacs
  ;; set line space wider than default
  (setq-default line-spacing 4)

  ;; chinese-fonts-setup is amazing
  (use-package cnfonts
    :ensure t
    :config
    (progn
      (setq cnfonts-profiles
            '("program" "org-mode" "read-book"))
      (setq cnfonts-profiles-directory (expand-file-name
                                        "chinese-fonts-setup"
                                        dotspacemacs-directory))
      (setq cnfonts--current-profile-name "program")
      (setq cnfonts-use-face-font-rescale t)
      )
    (cnfonts-enable)
    (cnfonts-set-spacemacs-fallback-fonts)
    )

  ;; 修改 frame 标题 方便 gnome-shell 桌面切换
  (setq frame-title-format '("" "%b: " buffer-file-name))
#+end_src

** 文本滚动
默认的闪花了眼. spacemacs 默认启用平滑滚动, 但鼠标的 wheel 操作还是偏快.

#+name: e7ef737b-dd78-4ba0-94e6-d63dc64ebb24
#+BEGIN_SRC emacs-lisp results: none
  ;; emacs scrolls too fast
  ;; http://stackoverflow.com/questions/445873/emacs-mouse-scrolling
  (setq mouse-wheel-scroll-amount '(1 ((Shift) . 2) ((control) . nil)))
  (setq mouse-wheel-progressive-speed nil)      ; constant speed
  (setq scroll-preserve-screen-position nil)    ; do not reposition the screen when moving the cursor

#+END_SRC

* calendar
cal-china-x: https://github.com/xwl/cal-china-x

#+name: init-calendar
#+BEGIN_SRC emacs-lisp
  (use-package cal-china-x)

  (setq mark-holidays-in-calendar t)

  (setq calendar-week-start-day 1)

  (setq general-holidays '(
               (holiday-fixed 1 1  "元旦")
               (holiday-fixed 2 14     "情人节")
               (holiday-fixed 3 14     "白色情人节")
               (holiday-fixed 4 1  "愚人节")
               (holiday-float 5 0 2    "母亲节")
               (holiday-float 6 0 3    "父亲节")
               (holiday-fixed 9 10     "教师节")
               (holiday-fixed 10 1     "国庆节")
               (holiday-fixed 12 25    "圣诞节")))

  (setq local-holidays '(
                 (holiday-lunar 12 30  "春节" 0)
                 (holiday-lunar 1 15     "元宵" 0)
                 (holiday-lunar 5 5  "端午" 0)
                 (holiday-lunar 7 7  "七夕" 0)
                 (holiday-lunar 8 15     "中秋" 0)
                 (holiday-lunar 8 25     "焱焱生日" 0)
                 (holiday-lunar 12 23     "金玉生日" 0)
                 (holiday-lunar 12 14     "文华生日" 0)
                 (holiday-lunar 2 3     "二毛生日" 0)
                 (holiday-lunar 9 9  "重阳" 0)
                 (holiday-lunar 12 8     "腊八" 0)
                 (holiday-lunar 12 24    "小年" 0)))

  (setq calendar-holidays local-holidays)

  (setq christian-holidays nil)
  (setq hebrew-holidays nil)
  (setq islamic-holidays nil)
  (setq solar-holidays nil)
  (setq bahai-holidays nil)
  (setq oriental-holidays nil)

  (setq calendar-mark-holidays-flag t)
  (setq mark-diary-entries t)
#+END_SRC

* development
:PROPERTIES:
:header-args: :noweb-ref init-dev
:END:
** 版本管理
#+name: 5a51cea8-f5ee-4b21-8c74-c704055fac6b
#+BEGIN_SRC emacs-lisp
  (setq vc-follow-symlinks t)
  ;; (remove-hook 'vc-checkout-hook 'time-stamp)
  ;; (add-hook 'vc-before-checkin-hook 'timestamp)
  (add-hook 'before-save-hook 'time-stamp)
#+END_SRC

** tab key
#+name: fc2c78fb-3f6d-47c9-9b92-60cee197beb4
#+BEGIN_SRC emacs-lisp
(setq user-mail-address "ybyygu@gmail.com")
(setq default-tab-width 4)
(setq tab-width 4)                             ; Length of tab is 4 SPC

#+END_SRC

** 自动完成
系统自带的 abbrev 功能比较简单. 可以用 M-/来激活补全.

#+name: e4c5c4a4-3c01-4361-b375-73b81af1ed18
#+BEGIN_SRC emacs-lisp
  ;; abbreviations
  (setq abbrev-file-name "~/.emacs.d/abbreviations")
  (when (file-exists-p abbrev-file-name)
    (quietly-read-abbrev-file))
  (setq save-abbrevs 'silently)
#+END_SRC

* org-mode
用于配置 org-mode 一些必要设置. 其它尽量使用 org-mode in-buffer 设置. 可
参考 tumashu 的设置 [[https://github.com/tumashu/emacs-helper/blob/master/eh-org.el][URL]]
** settings
#+name: init-org
#+begin_src elisp
  (add-to-list 'auto-mode-alist '("\\.note\\'" . org-mode))
  (add-to-list 'auto-mode-alist '("NOTE" . org-mode))

  (use-package org
    :ensure org-plus-contrib
    :config
    (progn
      (setq org-directory  "~/Notes")
      (setq org-default-notes-file (concat org-directory "/life.note"))
      (setq org-blank-before-new-entry nil)

      ;; disabled for updating to version 9.0
      ;; open link in new frame
      ;; (setq org-link-frame-setup
      ;;       (quote
      ;;        ((vm . vm-visit-folder-other-frame)
      ;;         (vm-imap . vm-visit-imap-folder-other-frame)
      ;;         (gnus . org-gnus-no-new-news)
      ;;         (file . find-file-other-frame)
      ;;         (wl . wl-other-frame))))
      )
    )
#+end_src
** agenda
*** init-org-agenda
用 use-package 来自动化处理

#+name: init-org-agenda
#+BEGIN_SRC elisp
  (use-package org-agenda
    :ensure org-plus-contrib
    :config
    (progn
      <<config-org-agenda>>
      )
    )

  ;; disabled for upgrading to org-9.0
  ;; auto export agenda
  ;; (defun gwp/run-agenda-store ()
  ;;   ""
  ;;   (message "Exporting agenda... ")
  ;;   (org-batch-store-agenda-views)
  ;;   (message "Agenda exported."))

  ;; ;; export agenda if I am away for 2 minutes
  ;; (run-with-idle-timer 600 t 'gwp/run-agenda-store)

#+END_SRC
*** config-org-agenda
#+name: config-org-agenda
#+BEGIN_SRC elisp
  ;; 2013-01-20: less is more
  ;; (setq org-agenda-files (append (file-expand-wildcards "~/Notes/*.note") (file-expand-wildcards "~/Notes/*/*.note")))
  (setq org-agenda-files "~/Notes/.agenda_files")

  (setq org-agenda-include-diary t)
  (setq org-agenda-span (quote month))

  ;; the default is todo-start
  (setq org-icalendar-use-scheduled (quote (event-if-not-todo event-if-todo todo-start)))
  (setq org-icalendar-alarm-time 5)

  (setq org-agenda-custom-commands
        '(("a" agenda "" nil ("~/Notes/org-cal.ics"))
          ("g" . "GTD contexts") ; description for "g" prefix
          )
        )

  (add-to-list 'org-agenda-custom-commands
               '("gr" "Reading"
                 ((tags-todo "Reading|Read"
                             (
                              (org-agenda-overriding-header "待读列表\n------------------")
                              (org-agenda-sorting-strategy '(category-keep priority-down))
                              (org-agenda-remove-tags t)
                              (org-agenda-compact-blocks t)
                              )
                             )
                  (tags "REFILE"
                        (
                         (org-agenda-overriding-header "Tasks to Refile\n------------------")
                         (org-tags-match-list-sublevels nil)
                         )
                        )
                  )
                 ((org-agenda-compact-blocks t))
                 )
               )

  (add-to-list 'org-agenda-custom-commands
               '("gt" "Tasks"
                 ((tags "ASAP+TODO=\"TODO\""
                        (
                         (org-agenda-overriding-header "ASAP\n------------------")
                         (org-agenda-sorting-strategy '(priority-down category-keep timestamp-up))
                         (org-agenda-max-entries 5)
                         )
                        )

                  (tags "Project+Action+TODO=\"TODO\""
                        (
                         (org-agenda-overriding-header "Project\n------------------")
                         (org-agenda-sorting-strategy '(priority-down category-keep timestamp-up))
                         )
                        )
                  (tags "Action+Study+TODO=\"TODO\""
                        (
                         (org-agenda-overriding-header "Topics\n------------------")
                         (org-agenda-files '("~/Notes/research.note"))
                         (org-agenda-sorting-strategy '(priority-down timestamp-up))
                         (org-agenda-max-entries 5)
                         )
                        )

                  (tags "Action+TODO=\"TODO\""
                        (
                         (org-agenda-overriding-header "生活琐事\n------------------")
                         (org-agenda-files '("~/Notes/life.note"))
                         (org-agenda-sorting-strategy '(priority-down timestamp-up))
                         (org-agenda-max-entries 5)
                         )
                        )

                  (tags "Computer+TODO=\"TODO\""
                        (
                         (org-agenda-overriding-header "电脑调优\n------------------")
                         (org-agenda-sorting-strategy '(priority-down timestamp-up))
                         (org-agenda-max-entries 5)
                         )
                        )
                  )
                 ;; options set here apply to the entire block
                 (
                  (org-tags-match-list-sublevels nil)
                  (org-agenda-prefix-format "%-20c ")
                  (org-agenda-todo-keyword-format "")
                  (org-agenda-remove-tags t)
                  (org-agenda-compact-blocks t)
                  )
                 )
               )

  ;; Show all future entries for repeating tasks
  (setq org-agenda-repeating-timestamp-show-all t)
  ;; do not show agenda dates if they are empty
  (setq org-agenda-show-all-dates nil)

  ;; Sorting order for tasks on the agenda
  (setq org-agenda-sorting-strategy
        (quote ((agenda time-up priority-down category-up)
                (todo priority-down)
                (tags priority-down))))

  ;; Start the weekly agenda today
  (setq org-agenda-start-on-weekday nil)
  ;; do not include todo items
  (setq org-agenda-include-all-todo nil)

#+END_SRC
** gpg crypt
#+name: init-org-crypt
#+begin_src elisp
  (require 'epa-file)
  (epa-file-enable)
  (require 'org-crypt)

  ;; Encrypt all entries before saving
  (org-crypt-use-before-save-magic)
  (setq org-crypt-tag-matcher "crypt")
  (setq org-tags-exclude-from-inheritance (quote ("crypt")))
  ; GPG key to use for encryption
  (setq org-crypt-key "38D95BC6411A87E7") ; ybyygu@gmail.com
  (setq org-crypt-disable-auto-save nil)
#+end_src

下面的用不到了. 因为是内置包.
#+name: 7c756a95-fbc4-4159-b6e7-bc4f3ebf972e
#+begin_src emacs-lisp
  (use-package epa-file
               :config
               (epa-file-enable)
               )

  (use-package org-crypt
               :after org
               :demand t
               :config
               (progn
                 <<config-org-crypt>>
                 )
               )
#+end_src

** exports
:PROPERTIES:
:header-args: :noweb-ref init-org-export
:END:

主要添加 cn-article classes, 修改使用 xelatex 来处理 tex 文档.

也可以用这个包: https://github.com/tumashu/ox-latex-chinese

*** file association
#+name: 70ff43af-9dfc-457c-b4b7-e423715cc689
#+BEGIN_SRC emacs-lisp
  ;; allow bind variables
  (setq org-export-allow-bind-keywords t)

  ;; disable evaluation when export source codes
  (setq org-export-babel-evaluate nil)

  ;; disabled for updating to version 9.0
  ;; PDFs visited in Org-mode are opened in Evince (and not in the default choice)
  ;; http://stackoverflow.com/a/8836108/789593
  ;; (delete '("\\.pdf\\'" . default) org-file-apps)
  ;; (delete '("\\.djvu\\'" . default) org-file-apps)
  ;; (delete '("\\.png\\'" . default) org-file-apps)
  ;; (delete '("\\.ods\\'" . default) org-file-apps)
  ;; (delete '("\\.doc\\'" . default) org-file-apps)
  ;; (delete '("\\.html\\'" . default) org-file-apps)
  ;; (add-to-list 'org-file-apps '("\\.pdf\\'" . "evince %s"))
  ;; (add-to-list 'org-file-apps '("\\.djvu\\'" . "evince %s"))
  ;; (add-to-list 'org-file-apps '("\\.ods\\'" . "libreoffice --calc %s"))
  ;; (add-to-list 'org-file-apps '("\\.doc\\'" . "libreoffice --writer %s"))
  ;; (add-to-list 'org-file-apps '("\\.png\\'" . "eog %s"))
  ;; (add-to-list 'org-file-apps '("\\.html\\'" . "firefox %s"))

#+END_SRC
*** latex
- 中文设置
- 以后可以考虑使用 ox-latex-chinese包

#+name: f0388b8f-03f1-4caf-9630-3760aba9bb2d
#+BEGIN_SRC emacs-lisp
  (require 'ox-beamer)
  (require 'ox-latex)

  (defun my-auto-tex-parameters ()
        "setup xelatex environment"

        (setq org-latex-classes
              (cons '("article"
                      "\\documentclass[11pt,article,oneside]{memoir}"
                      ("\\section{%s}" . "\\section*{%s}")
                      ("\\subsection{%s}" . "\\subsection*{%s}")
                      ("\\subsubsection{%s}" . "\\subsubsection*{%s}")
                      ("\\paragraph{%s}" . "\\paragraph*{%s}")
                      ("\\subparagraph{%s}" . "\\subparagraph*{%s}"))
                    org-latex-classes))

        (setq org-latex-classes
              (cons '("cn-article"
                      "\\documentclass[nocap]{ctexart}
                      [NO-DEFAULT-PACKAGES]
                      [NO-PACKAGES]"
                      ("\\section{%s}" . "\\section*{%s}")
                      ("\\subsection{%s}" . "\\subsection*{%s}")
                      ("\\subsubsection{%s}" . "\\subsubsection*{%s}")
                      ("\\paragraph{%s}" . "\\paragraph*{%s}")
                      ("\\subparagraph{%s}" . "\\subparagraph*{%s}"))
                    org-latex-classes))
        )

  (my-auto-tex-parameters)

  ;; Use XeLaTeX to export PDF in Org-mode
  (setq org-latex-pdf-process
        '("xelatex -interaction nonstopmode -output-directory %o %f"
          "xelatex -interaction nonstopmode -output-directory %o %f"
          "xelatex -interaction nonstopmode -output-directory %o %f")
        )
#+END_SRC

默认公式预览图片太小, 改大一些([[https://emacs.stackexchange.com/questions/19880/font-size-control-of-latex-previews-in-org-files][URL]]):
#+name: 32a6da28-5f14-4433-ac15-6d2749b036f5
#+BEGIN_SRC elisp
  ;; bigger latex fragment
  (setq org-format-latex-options (plist-put org-format-latex-options :scale 1.5))
#+END_SRC

** refile
#+name: init-org-refile
#+BEGIN_SRC emacs-lisp
  ;; any headline with level <= 2 is a target
  (setq org-refile-targets '(
                             (org-agenda-files :tag . "Incoming")
                             )
        )

  (setq org-reverse-note-order t)
  (defun gwp/get-org-file-link-path ()
    (save-excursion
      (beginning-of-line)
      (search-forward "[[file:" (line-end-position))
      (if (org-in-regexp org-bracket-link-regexp 1)
          (org-link-unescape (match-string-no-properties 1))
        )
      )
    )

  (defun gwp/enter-to-read-state()
    "evoke external shell script when entering READ state"
    (when (equal org-state "READ")
      (setq file (gwp/get-org-file-link-path))
      (if file
          (progn
           (setq cmd (concat "org-to-read.sh " (shell-quote-argument file)))
           (message cmd)
           (shell-command cmd)
          )
          )
      )
      (when (equal org-last-state "READ")
        (message "try to remove READ state")
        (setq file (gwp/get-org-file-link-path))
        (if file
            (progn
              (setq cmd (concat "org-read-done.sh " (shell-quote-argument file)))
              (message cmd)
              (shell-command cmd)
              )
          )
        )
    )
  (add-hook 'org-after-todo-state-change-hook 'gwp/enter-to-read-state)

  ;; show a sparse-tree in READ keyword
  (defun gwp/org-show-read-tree ()
    "show a sparse-tree in READ keyword"
    (interactive)

    (let ((base-vector [?\C-u ?\M-x ?o ?r ?g ?- ?s ?h ?o ?w ?- ?t ?o ?d ?o ?- ?t ?r ?e ?e return ?R ?E ?A ?D return]))
      ;; create new macro of the form
      ;; C-u M-x org-show-todo-tree RET READ RET
      (execute-kbd-macro (vconcat base-vector
                                  (vector 'return)))))

#+END_SRC

** screenshot
*** org-attach-screenshot [[https://github.com/dfeich/org-screenshot][URL]]
感觉这个包比 org-download 质量更高一些. 优点:
1. 截屏的时候自动隐藏当前编辑窗口.
2. 使用 org-attach 来处理文件的删除.

使用deepin-screenshot

#+name: init-org-screenshot
#+BEGIN_SRC emacs-lisp :results none
  (defun gwp/init-org-attach-screenshot ()
    (use-package org-attach-screenshot
                 :after org
                 :bind
                 (("C-c <insert>" . org-attach-screenshot))
                 :config
                 (setq org-attach-screenshot-command-line "deepin-screenshot -s %f")
                 )
    )
#+END_SRC

如果使用 shutter:
: shutter -s -n -e --disable_systray -o

*** org-download
使用 org-download 包来实现截屏的功能. 这是 spacemacs org layer 中使用的包.

#+name: 181ec62b-f55b-4e03-943d-1c43cf692774
#+BEGIN_SRC elisp
  (use-package org-download
               :after org
               :disabled t
               :config
               (progn
                 ;; (setq org-download-method 'directory)
                 ;; or
                 (setq org-download-method 'attach)
                 (setq-default org-download-image-dir "./images/")
                 (setq org-download-screenshot-method "emacs-take-snapshot.sh %s")
                 ;; disable annotation
                 (setq org-download-annotate-function (lambda (_) ""))
                 )
               )
#+END_SRC
*** gwp/insert-screen
#+name: 7381b29d-aefa-4d01-a3ee-1bcd6d52f28c
#+BEGIN_SRC emacs-lisp
  (defun delete-linked-file (start end)
    "Delete the file named at point."

    (interactive "r")

    (let ((file (buffer-substring start end)))
      (setq file (replace-regexp-in-string "^\s*\\[\\[" "" file))
      (setq file (replace-regexp-in-string "\\]\\]\s*$" "" file))
      (setq file (replace-regexp-in-string "^\s*file:" "" file))
      (message "filename %s" file)
      (if (and (file-exists-p file) (y-or-n-p (format "Delete %s? " file)))
          (progn
            (delete-region start end)
            (delete-file file)
            (message "Deleted %s" file)
            )
        (progn
          (message "Did not delete %s" file)
          )
        )
      )
    )

  (defun insert-screen (path)
    "Save screenshot into sub directory named as images.
    To use this function, you need install shutter"
    (interactive "P")

    (setq insert t)
    (if (org-in-regexp org-bracket-link-regexp 1)
        (progn
          (setq path (match-string-no-properties 1))
          (setq insert nil)
        )
      (progn
        (setq path (make-temp-name (format-time-string "images/%Y-%m-%d-%H%M")))
        (setq path (concat path ".png"))
        (setq insert t)
        )
      )

    (setq path (read-string "File name: " path))
    (if insert
        (insert (format "[[file:%s]]" path))
        )

    (shell-command (format "emacs-take-snapshot.sh %s" path))
    (message (concat "You have save screen as " path " at: " (file-name-directory buffer-file-name)))
    )

  (defun insert-link-from-clipboard-old (name)
    "Save file path in clipboard as link"
    (interactive "sLink description: ")

    ;; UTF8_STRING is necessary to work for copying in nautilus
    (setq content (x-get-selection 'CLIPBOARD 'UTF8_STRING))
    (if (file-readable-p content)
        (progn
          (setq link-path (file-relative-name content))
          (insert (format "[[file:%s][%s]]" link-path name))
          )
      (message "No file path found in clipboard.")
      )
    (setq current-prefix-arg '(4)) ; C-u
    (let ((default-directory choose-directory-default-directory))
      (call-interactively 'org-insert-link)
      )
    )

  (defun insert-link-from-clipboard (something)
    "Save file path in clipboard as relative link"
    (interactive "sEnter desc: ")
    (let ((base-vector [?\C-u ?\M-x ?o ?r ?g ?- ?i ?n ?s ?e ?r ?t ?- ?l ?i ?n ?k return ?\C-v return]))
      ;; create new macro of the form
      ;; C-u M-x org-insert-link RET C-v RET
      (execute-kbd-macro (vconcat base-vector
                                  (string-to-vector something)
                                  (vector 'return)))))

#+END_SRC
** zotero
主要是用来支持 "zotero:" 链接的.

#+name: init-org-zotero
#+begin_src emacs-lisp
  ;; org-add-link-type is obsolete as of org-mode 9.
  ;; Instead we will use the org-link-set-parameters method

  ;; org 8
  ;; (org-add-link-type "zotero"
  ;;                    'gwp/org-zotero-open
  ;;                    'gwp/org-zotero-export)

  ;; org 9
  (org-link-set-parameters "zotero" :follow #'gwp/org-zotero-open :export #'gwp/org-zotero-export)

  (defun gwp/org-zotero-open (path)
    (setq url (format "zotero:%s" path))
    ;; (message-box url)
    (browse-url url)
    )

  (defun gwp/org-zotero-export (path desc format)
    "Create the export version of zotero link specified by PATH and
  DESC. FORMATs understood are 'odt','latex and 'html."
    (cond
     ((eq format 'html)
      (format "<a href=\"zotero:%s\">%s</a>" path desc))
     ((eq format 'latex)
      (format "\\href{zotero:%s}{%s}" path desc))
     (t desc)
     )
    )

#+end_src

** babel
:PROPERTIES:
:header-args: :noweb-ref init-org-babel
:END:
*** common
#+name: 08773fc4-f834-41ef-96bd-695b7eb0668e
#+begin_src emacs-lisp
  ;; (org-babel-do-load-languages
  ;;  'org-babel-load-languages
  ;;  '((python . t)
  ;;    (R . t)
  ;;    (sh . t)
  ;;    (C . t)
  ;;    (perl . t)
  ;;    (plantuml . t)
  ;;    )
  ;;  )

  ;; (setq org-plantuml-jar-path
  ;;       (expand-file-name "~/.emacs.d/plantuml/plantuml.jar"))

  ;; (defun gwp/display-inline-images ()
  ;;   (condition-case nil
  ;;       (org-display-inline-images)
  ;;     (error nil)))
  ;; (add-hook 'org-babel-after-execute-hook 'gwp/display-inline-images 'append)

  (setq org-confirm-babel-evaluate nil)

  ;; add <p for python expansion
  (add-to-list 'org-structure-template-alist
               '("p" "#+begin_src python\n?\n#+end_src" "<src lang=\"python\">\n?\n</src>"))

  ;; add <el for emacs-lisp expansion
  (add-to-list 'org-structure-template-alist
               '("el" "#+begin_src emacs-lisp\n?\n#+end_src" "<src lang=\"emacs-lisp\">\n?\n</src>"))

  ;; add <b for shell scritp
  (add-to-list 'org-structure-template-alist
               '("b" "#+begin_src shell \n?\n#+end_src" "<src lang=\"shell\">\n?\n</src>"))

#+end_src
*** literate programming
#+name: c5a08df6-7fd7-408b-9fb3-b4eb7347e84e
#+BEGIN_SRC elisp
  ;; unique, memorable identity for tangling
  ;; (setq org-id-prefix (format-time-string "%Y%m%d"))
  ;; the default is ok for me
  ;; (setq org-id-method 'uuid)
#+END_SRC

#+name: b5128b51-bf3b-48f7-a96e-51417a752882
#+BEGIN_SRC elisp
  ;; helper functions for literate programming
  ;; taking from: https://github.com/grettke/help/blob/master/Org-Mode_Fundamentals.org
  (defun help/set-org-babel-default-header-args (property value)
    "Easily set system header arguments in org mode.

  PROPERTY is the system-wide value that you would like to modify.

  VALUE is the new value you wish to store.

  Attribution: URL `http://orgmode.org/manual/System_002dwide-header-arguments.html#System_002dwide-header-arguments'"
    (setq org-babel-default-header-args
          (cons (cons property value)
                (assq-delete-all property org-babel-default-header-args))))

  (defun help/set-org-babel-default-inline-header-args (property value)
    "See `help/set-org-babel-default-header-args'; same but for inline header args."
    (setq org-babel-default-inline-header-args
          (cons (cons property value)
                (assq-delete-all property org-babel-default-inline-header-args))))

  (defun help/set-org-babel-default-header-args:R (property value)
    "See `help/set-org-babel-default-header-args'; same but for R.

  This is a copy and paste. Additional languages would warrant a refactor."
    (setq org-babel-default-header-args:R
          (cons (cons property value)
                (assq-delete-all property org-babel-default-header-args:R))))

  (defun help/set-org-babel-default-header-args:ditaa (property value)
    "See `help/set-org-babel-default-header-args'; same but for ditaa.

  This is a copy and paste. Additional languages would warrant a refactor."
    (setq org-babel-default-header-args:ditaa
          (cons (cons property value)
                (assq-delete-all property org-babel-default-header-args:ditaa))))

  (defun help/set-org-babel-default-header-args:dot (property value)
    "See `help/set-org-babel-default-header-args'; same but for dot.

  This is a copy and paste. Additional languages would warrant a refactor."
    (setq org-babel-default-header-args:dot
          (cons (cons property value)
                (assq-delete-all property org-babel-default-header-args:dot))))

  (defun help/set-org-babel-default-header-args:plantuml (property value)
    "See `help/set-org-babel-default-header-args'; same but for plantuml.

  This is a copy and paste. Additional languages would warrant a refactor."
    (setq org-babel-default-header-args:plantuml
          (cons (cons property value)
                (assq-delete-all property org-babel-default-header-args:plantuml))))

  (defun help/org-toggle-macro-markers ()
    (interactive)
    (setq org-hide-macro-markers (not org-hide-macro-markers)))

  (defun help/org-prp-hdln ()
    "Visit every Headline. If it doesn't have an ID property then add one and
    assign it a UUID. Attribution: URL
    `http://article.gmane.org/gmane.emacs.orgmode/99738'. It is OK to leave the
    colon separator in here because these are never used as Source-Blocks and
    the rest of the code expects the colon separator."
    (interactive)
    (save-excursion
      (goto-char (point-min))
      (dolist (p (nreverse
                  (org-element-map (org-element-parse-buffer 'headline) 'headline
                    (lambda (headline) (org-element-property :begin headline)))))
        (goto-char p)
        (org-id-get-create))
      (save-buffer)))

  (defun help/org-id-new ()
    "Re-purposing `org-id' hit a snag when colons were forbidden in Source-Block
    names. Adding support for a user-defined Org-Id separator would have fixed
    this but with no benefit to Org-Id. So this function removes the colon
    instead.
   "
    (interactive)
    (let* ((gend (org-id-new))
           (newid (replace-regexp-in-string ":" "_" gend)))
      newid))

  (defun help/org-prp-src-blk ()
    "If it doesn't have a NAME property then add one and
     assign it a UUID. Attribution: URL `http://article.gmane.org/gmane.emacs.orgmode/99740'"
    (interactive)
    (help/org-2every-src-block
     #'(lambda (element)
         (if (not (org-element-property :name element))
             (let ((i (org-get-indentation)))
               (beginning-of-line)
               (save-excursion (insert "#+name: " (help/org-id-new) "\n"))
               (indent-to i)
               (forward-line 2))))))

  (defconst help/org-special-pre "^\s*#[+]")

  (defun help/org-2every-src-block (fn)
    "Visit every Source-Block and evaluate `FN'."
    (interactive)
    (save-excursion
      (goto-char (point-min))
      (let ((case-fold-search t))
        (while (re-search-forward (concat help/org-special-pre "BEGIN_SRC") nil t)
          (let ((element (org-element-at-point)))
            (when (eq (org-element-type element) 'src-block)
              (funcall fn element)))))
      (save-buffer)))

  (defun help/org-babel-demarcate-block ()
    "Add a NAME property then assign it a UUID."
    (interactive)
    (org-babel-demarcate-block)
    (insert "#+name: " (help/org-id-new))
    (beginning-of-line)
    (insert "\n"))
#+END_SRC

#+name: d3151aaf-84cf-484a-9513-40a671de7081
#+BEGIN_SRC elisp
  ;; (add-hook 'org-babel-pre-tangle-hook #'help/org-prp-hdln)
  (add-hook 'org-babel-pre-tangle-hook #'help/org-prp-src-blk)
#+END_SRC
* server mode
修改.spacemacs 文件:
: (setq-default dotspacemacs-persistent-server t)

退出 server 的方法:
: SPC q q
: SPC q s

#+name: 139c7654-b2cd-4c3c-9b37-a5ee6a64aef4
#+BEGIN_SRC emacs-lisp
  ;; using existing Emacs process as the server
  (server-start)

  (defun gwp/quit-frame-and-kill-buffer ()
    "kill the current buffer and the current frame"
    (interactive)

    (remove-hook 'kill-buffer-query-functions 'server-kill-buffer-query-function)
    (kill-buffer)
    (delete-frame)
    )

  ;; quit emacs server
  (global-set-key (kbd "<C-f4>") 'save-buffers-kill-emacs)

  ;; http://stackoverflow.com/questions/268088/how-to-remove-the-prompt-for-killing-emacsclient-buffers
  ;; this seems work
  (defalias 'server-kill-buffer-query-function '(lambda () t))

#+END_SRC

* spacemacs
** install
官方首页提供了三种安装方式. 迁移的时候考虑使用第二种或第三种.

1. spacemacs 目录放置到~/Install/configs/spacemacs/.emacs.d
   : git clone https://github.com/syl20bnr/spacemacs.git ~/Install/configs/spacemacs/.emacs.d

2. 修改配置文件中的路径
   elpa 默认仍是存在~/.emacs.d/elpa 下, 可以用 [[https://www.gnu.org/software/emacs/manual/html_node/emacs/Package-Files.html][package-user-dir]] 修改.

   #+header: :tangle init.el
   #+name: ebd036c8-02a2-404c-a5c7-b5cff07806b8
   #+begin_src emacs-lisp
     (setq spacemacs-start-directory "~/Install/configs/spacemacs/.emacs.d/")
     (setq package-user-dir (file-name-as-directory
                             (concat spacemacs-start-directory "elpa/")))
     (load-file (concat spacemacs-start-directory "init.el"))
   #+end_src

3. 命令行启动 emacs
   #+header: :tangle start.sh
   #+header: :shebang #! /bin/sh
   #+name: 95e88efd-b916-4a5e-b929-9d1584b237b1
   #+begin_src sh
     # HOME=`pwd` emacs
     # emacs -q -l ...
     emacs --no-init-file --load ~/Install/configs/spacemacs/init.el
   #+end_src

** tips
*** 粘贴替换选中文字
vi模式下使用P命令.
*** 参看spacemacs帮助 SPC h SPC
*** gold-ratio 可以自动放大当前的 window 区域: SPC t g
*** 使用外部程序打开文件的方式
emacs 默认使用 docview mode 来打开链接的文件, 比如 PDF 等, 不太方便. 操作步骤:
1. dired-jump (SPC fj): 使用 dired 打开当前文件所在目录
2. 在 dired 界面上选择某个文件, 使用 external 程序打开 (SPC fo).
3. 也可以在 dired 界面上用"!"命令, 指定任意程序打开.
*** user-init 和 user-config
from FAQ: [[http://spacemacs.org/doc/FAQ.html][URL]]

1.12 Should I place my settings in user-init or user-config?

Any variable that layer configuration code will read and act on must be set in
user-init, and any variable that Spacemacs explicitly sets but you wish to
override must be set in user-config.

Anything that isn't just setting a variable should 99% be in user-config.
*** 打开.spacemacs 配置文件
: SPC f e d
*** 调整字体大小 (zoom)
: SPC z x +/-
*** universal arguments
SPC u
** dot-spacemacs
这里设置 .spacemacs 相关的细节. .spacemacs 文件可放到.spacemacs.d 文件中,
并更名为 init.el
*** user-init
配置 elpa 国内源
#+name: 967df1e6-6633-4688-a36f-e8a5b8c1dfc5
#+BEGIN_SRC elisp
  (defun dotspacemacs/user-init ()
    "Initialization function for user code.
  It is called immediately after `dotspacemacs/init', before layer configuration
  executes.
   This function is mostly useful for variables that need to be set
  before packages are loaded. If you are unsure, you should try in setting them in
  `dotspacemacs/user-config' first."
    (setq configuration-layer--elpa-archives
          '(("melpa-cn" . "https://elpa.zilongshanren.com/melpa/")
            ("org-cn"   . "https://elpa.zilongshanren.com/org/")
            ("gnu-cn"   . "https://elpa.zilongshanren.com/gnu/")))
    )
#+END_SRC
*** user-config
#+name: fce76046-c66a-4702-a1d3-bc15226fdb78
#+begin_src emacs-lisp
  (setq-default dotspacemacs-persistent-server t)
#+end_src
*** custom-file
#+name: 12d528df-8fd6-4711-84fb-7e09508283d1
#+begin_src emacs-lisp
  (setq custom-file (expand-file-name "custom.el" dotspacemacs-directory))
  (load custom-file 'no-error 'no-message)
#+end_src

在.spacemacs 文件最后添加
** gwp layer
*** packages.el
通过 packages.el 接口, 可以将自己的一些设置与 spacemacs 融为一体.

#+header: :tangle ~/.spacemacs.d/layers/gwp/packages.el
#+header: :noweb yes :comments link :padline yes
#+name: 8d9d4320-8a15-4b4b-8b4d-40c58b895804
#+BEGIN_SRC elisp
  ;;; packages.el --- gwp layer packages file for Spacemacs.

  ;;; Commentary:

  ;; Briefly, each package to be installed or configured by this layer should be
  ;; added to `gwp-packages'. Then, for each package PACKAGE:
  ;;
  ;; - If PACKAGE is not referenced by any other Spacemacs layer, define a
  ;;   function `gwp/init-PACKAGE' to load and initialize the package.

  ;; - Otherwise, PACKAGE is already referenced by another Spacemacs layer, so
  ;;   define the functions `gwp/pre-init-PACKAGE' and/or
  ;;   `gwp/post-init-PACKAGE' to customize the package as it is loaded.

  ;;; Code:

  (defconst gwp-packages
    '(
      (org :location built-in)
      ;; (org-bullets :excluded t)  ;; shipped with spacemacs in org layer
      (org-download :excluded t) ;; shipped with spacemacs in org layer
      (hl-todo :excluded t)      ;; shipped with spacemacs in spacemacs-ui-visual layer
      cnfonts
      cal-china-x
      ox-latex-chinese
      org-attach-screenshot
      fcitx
      ;; pangu-spacing
      )

    "The list of Lisp packages required by the gwp layer.")

  (defun gwp/init-cnfonts ()
    <<init-ui>>

    <<init-dev>>
    )

  (defun gwp/init-cal-china-x ()
    <<init-calendar>>
    )

  (defun gwp/post-init-org ()
    (with-eval-after-load 'org
      (progn
        <<init-org>>
        <<init-org-agenda>>
        <<init-org-crypt>>
        <<init-org-export>>
        <<init-org-refile>>
        <<init-org-babel>>
        <<init-org-zotero>>
        )
      )
    )

  (defun gwp/init-ox-latex-chinese ()
    ;;
    )

  (defun gwp/init-fcitx ()
    (use-package fcitx
      :init
      (setq fcitx-active-evil-states '(insert emacs hybrid)) ; if you use hybrid mode
      ;; M-m is common in Spacemacs
      (fcitx-prefix-keys-add "M-m")

      ;; for Linux users, it is recommended
      (fcitx-aggressive-setup)
      (setq fcitx-use-dbus t)
      )
    )

  <<init-org-screenshot>>

  ;; codes taken from chinese-layer
  ;; (defun gwp/init-pangu-spacing ()
  ;;   (use-package pangu-spacing
  ;;     :defer t
  ;;     :init (progn (global-pangu-spacing-mode 1)
  ;;                  (spacemacs|hide-lighter pangu-spacing-mode)
  ;;                  ;; Always insert `real' space in org-mode.
  ;;                  (add-hook 'org-mode-hook
  ;;                            '(lambda ()
  ;;                               (set (make-local-variable 'pangu-spacing-real-insert-separtor) t))))))


  ;;; packages.el ends here

#+END_SRC
*** keybindings.el
#+header: :tangle ~/.spacemacs.d/layers/gwp/keybindings.el
#+name: 4ea1e496-e909-40a7-bbf7-f4ced06210fd
#+BEGIN_SRC emacs-lisp
  ;; (global-set-key (kbd "C-l") 'goto-line)

  ;; make it easier to paste things
  ;; (define-key evil-insert-state-map (kbd "C-v") 'yank)
  ;; becasue I use hybrid mode
  (define-key evil-hybrid-state-map (kbd "C-v") 'yank)

  ;; make it easier to undo
  (define-key evil-hybrid-state-map (kbd "C-z") 'undo-tree-undo)
  (define-key evil-hybrid-state-map (kbd "M-u") 'undo-tree-undo)

  (defun gwp/insert-date (arg)
    "Insert date at point. With prefix argument, insert date and time."
    (interactive "P")
    (insert (format-time-string "%Y-%m-%d"))
    (when arg
      (insert (format-time-string " %H:%M"))
      )
    )

  ;; make it easier to update time-stamp
  ;; (global-set-key (kbd "C-c i") 'gwp/insert-date)
  (define-key evil-hybrid-state-map (kbd "C-c i") 'gwp/insert-date)

  ;; whitespace
  (setq show-trailing-whitespace t)
  (global-set-key (kbd "<f5> SPC") 'delete-trailing-whitespace)
  ;; make sure this always work
  (global-set-key (kbd "C-x C-o") 'delete-blank-lines)

  ;; tangle current block in org-babel
  ;; http://stackoverflow.com/questions/28727190/org-babel-tangle-only-one-code-block
  (defun gwp/org-babel-tangle-block()
    (interactive)
    (let ((current-prefix-arg '(4)))
      (call-interactively 'org-babel-tangle)
      )
    )

  (eval-after-load "org"
    '(progn
       (org-defkey org-mode-map [(meta return)] 'org-meta-return)
       ;; use o as org global bindings
       (spacemacs/set-leader-keys
         "oa" 'org-agenda
         "oc" 'org-capture
         "ol" 'org-store-link
         "ob" 'gwp/org-babel-tangle-block
         )
       ))

  ;; http://stackoverflow.com/questions/268088/how-to-remove-the-prompt-for-killing-emacsclient-buffers
  ;; this seems work
  (defalias 'server-kill-buffer-query-function '(lambda () t))

  ;; insert pairs
  (defvar my-skeleton-pair-alist
    '((?\) . ?\()
      (?\] . ?\[)
      (?} . ?{)
      (?" . ?")
      )
    )

  (defun my-skeleton-pair-end (arg)
    "Skip the char if it is an ending, otherwise insert it."
    (interactive "*p")
    (let ((char last-command-char))
      (if (and (assq char my-skeleton-pair-alist)
               (eq char (following-char)))
          (forward-char)
        (self-insert-command (prefix-numeric-value arg))
        )
      )
    )

  (global-set-key (kbd "<f5> (") 'insert-pair)
  (global-set-key (kbd "<f5> <") 'insert-pair)
  (global-set-key (kbd "<f5> [") 'insert-pair)
  (global-set-key (kbd "<f5> {") 'insert-pair)
  (global-set-key (kbd "<f5> \"") 'insert-pair)
  (global-set-key (kbd "<f5> '") 'insert-pair)
  (global-set-key (kbd "<f5> C-d") 'delete-pair)

  ;; remap C-a
  (global-set-key [remap org-beginning-of-line]
                  'evil-first-non-blank-of-visual-line)
  ;; remap C-e
  (global-set-key [remap evil-scroll-line-down]
                  'evil-end-of-visual-line)

  ;; 自动扩选
  ;; http://xahlee.org/emacs/modernization_mark-word.html
  ;; by Nikolaj Schumacher, 2008-10-20. Released under GPL.
  (defun semnav-up (arg)
    (interactive "p")
    (when (nth 3 (syntax-ppss))
      (if (> arg 0)
          (progn
            (skip-syntax-forward "^\"")
            (goto-char (1+ (point)))
            (decf arg))
        (skip-syntax-backward "^\"")
        (goto-char (1- (point)))
        (incf arg)))
    (up-list arg))

  ;; by Nikolaj Schumacher, 2008-10-20. Released under GPL.
  (defun gwp/extend-selection (arg &optional incremental)
    "Select the current word.
  Subsequent calls expands the selection to larger semantic unit."
    (interactive (list (prefix-numeric-value current-prefix-arg)
                       (or (and transient-mark-mode mark-active)
                           (eq last-command this-command))))
    (if incremental
        (progn
          (semnav-up (- arg))
          (forward-sexp)
          (mark-sexp -1))
      (if (> arg 1)
          (extend-selection (1- arg) t)
        (if (looking-at "\\=\\(\\s_\\|\\sw\\)*\\_>")
            (goto-char (match-end 0))
          (unless (memq (char-before) '(?\) ?\"))
            (forward-sexp)))
        (mark-sexp -1))))

  ;; (global-set-key (kbd "<f5> v") 'gwp/extend-selection)

  (defun gwp/select-text-in-quote ()
  "Select text between the nearest left and right delimiters.
  Delimiters are paired characters: ()[]<>«»“”‘’「」, including \"\"."
   (interactive)
   (let (b1 b2)
     (skip-chars-backward "^<>(“{[「«\"‘")
     (setq b1 (point))
     (skip-chars-forward "^<>)”}]」»\"’")
     (setq b2 (point))
     (set-mark b1)
     )
   )

  (defun gwp/select-none-blank-text ()
  "Select none blank chars near the point in current line"
   (interactive)
   (let (b1 b2)
     (skip-chars-backward "^ \n")
     (setq b1 (point))
     (skip-chars-forward "^ \n")
     (setq b2 (point))
     (set-mark b1)
     )
   )

  (defun gwp/select-word ()
  "Select none blank chars near the point in current line"
   (interactive)
   (let (b1 b2)
     (backward-word)
     (setq b1 (point))
     (forward-word)
     (setq b2 (point))
     (set-mark b1)
     )
   )

  (defun gwp/select-line ()
  "Select current line"
   (interactive)
   (let (b1 b2)
     (move-beginning-of-line nil)
     (setq b1 (point))
     (move-end-of-line nil)
     (setq b2 (point))
     (set-mark b1)
     )
   )

  ;; (global-set-key (kbd "M-*") 'select-text-in-quote)
  ;; (global-set-key (kbd "M-6") 'select-line)
  ;; (global-set-key (kbd "M-4") 'select-word)
  (global-set-key (kbd "M-5") 'gwp/select-none-blank-text)

  ;; https://github.com/magnars/expand-region.el
  ;; (require 'expand-region)
  ;; (global-set-key (kbd "M-4") 'er/expand-region)


#+END_SRC

*** config.el
这里添加 gwp layer 本身需要的配置. 暂时没有必要.

* deprecated
以下旧的配置在spacemacs中都不再需要了.
** development
*** 高亮当前行
所有已定义的颜色:
: list-colors-display

#+name: 52fcb671-cd31-4c84-bb30-c22b87b85558
#+BEGIN_SRC emacs-lisp
  (global-hl-line-mode 1)
  (set-face-attribute hl-line-face nil :underline nil :background "gray0")
#+END_SRC

*** 书签&导航等
主要用 bm, 书签持久化是从 bm.el 里抄来的.

#+name: 31e72f88-fb21-4cd4-b5eb-fcc6d393291a
#+BEGIN_SRC emacs-lisp
  (starter-kit-install-if-needed 'bm)
  (setq bm-restore-repository-on-load t)

  (require 'bm)
  (global-set-key (kbd "<left-fringe> <mouse-5>") 'bm-next-mouse)
  (global-set-key (kbd "<left-margin> <mouse-5>") 'bm-next-mouse)
  (global-set-key (kbd "<left-fringe> <mouse-4>") 'bm-previous-mouse)
  (global-set-key (kbd "<left-margin> <mouse-4>") 'bm-previous-mouse)
  (global-set-key [left-margin mouse-3] 'gwp-mouse-toggle-bm)
  (global-set-key [left-fringe mouse-3] 'gwp-mouse-toggle-bm)

  (setq-default bm-buffer-persistence t)
  (add-hook' after-init-hook 'bm-repository-load)
  (add-hook 'find-file-hooks 'bm-buffer-restore)
  (add-hook 'kill-buffer-hook 'bm-buffer-save)
  (add-hook 'kill-emacs-hook '(lambda nil
                    (bm-buffer-save-all)
                    (bm-repository-save)))

  (add-hook 'after-save-hook 'bm-buffer-save)
  ;; Restore bookmarks when buffer is reverted.
  (add-hook 'after-revert-hook 'bm-buffer-restore)
  ;; make sure bookmarks is saved before check-in (and revert-buffer)
  (add-hook 'vc-before-checkin-hook 'bm-buffer-save)

  (defun gwp-mouse-toggle-bm (e)
    "Toggle bookmarking
  This command should be bound to a mouse key.
  Argument E is a mouse event used by `mouse-set-point'."
    (interactive "@e")
    (save-excursion
      (mouse-set-point e)
      (bm-toggle)
      (bm-save)
      )
    )


#+END_SRC

#+RESULTS:
: gwp-mouse-toggle-bm

*** 注释
#+name: eae47e9e-63d5-47cd-a2a0-542299176edf
#+BEGIN_SRC emacs-lisp
  ; (starter-kit-install-if-needed 'line-comment-banner)
  ; (require 'line-comment-banner)
  ; (global-set-key (kbd "<f5> ;") 'line-comment-banner)

  ;; stolen from: http://www.emacswiki.org/emacs/CommentingCode
  (defun comment-dwim-line (&optional arg)
    "Replacement for the comment-dwim command.
    If no region is selected and current line is not blank and we are not at the end of the line,
    then comment current line.
    Replaces default behaviour of comment-dwim, when it inserts comment at the end of the line."
      (interactive "*P")
      (comment-normalize-vars)
      (if (and (not (region-active-p)) (not (looking-at "[ \t]*$")))
      (comment-or-uncomment-region (line-beginning-position) (line-end-position))
        (comment-dwim arg)))
  (global-set-key "\M-;" 'comment-dwim-line)


#+END_SRC

#+RESULTS:
: comment-dwim-line

*** 自动完成
系统自带的 abbrev 功能比较简单. 可以用 M-/来激活补全.

#+name: bd2fab61-6c36-40a0-ac52-301e0713ba3a
#+BEGIN_SRC emacs-lisp
  ;;
  ;; auto-complete
  ;; http://auto-complete.org/doc/manual.html
  ;;
  (starter-kit-install-if-needed 'auto-complete)
  (require 'auto-complete-config)
  (add-to-list 'ac-dictionary-directories "~/.emacs.d/ac-dict")
  (ac-config-default)
  ;; auto-start is really annoying
  (setq ac-auto-start nil)
  ;; override the default hippie-expand
  (define-key ac-mode-map (kbd "M-TAB") 'auto-complete)
  ;; (ac-set-trigger-key "TAB")

  ;;
  ;; yasnisppet
  ;;
  (starter-kit-load "yasnippet")

  ;; abbreviations
  (setq abbrev-file-name "~/.emacs.d/abbreviations")
  (when (file-exists-p abbrev-file-name)
    (quietly-read-abbrev-file))
  (setq save-abbrevs 'silently)
#+END_SRC

#+RESULTS:
: silently

** python
*** 使用 emacs 中自带的 python.el
   试了下, 一切都正常. 先这么着吧.

  #+name: 90a43e0b-e10c-4ce9-8d1f-d5ee95fd77f6
  #+begin_src emacs-lisp
    ;; (starter-kit-load "python")
    ;; Why python.el is better than python-mode.el:
    ;; http://mail.python.org/pipermail/python-mode/2007-October/000411.html

    (starter-kit-install-if-needed 'highlight-indentation)

    ;; enables IPython globally
    (setq python-shell-interpreter "ipython"
         python-shell-interpreter-args "--simple-prompt")

    (defun my-python-hook ()
      ;; disabled at 2013-01-19. will slow down the scrolling when codes was folded
      (linum-mode 1)
      ;; make left margin not jumpy
      ;; learned from:
      (setq linum-format "%3d\u2502")
      (menu-bar-mode 1)

      ;; easy reading the hierarchy of the code; I known that from elpy package
      (highlight-indentation-mode 1)

      ;; (load-ropemacs)
      ;; (ropemacs-mode 1)

      ;; org-mode style cycling folding
      ;; actually does not work in v6.0.12; maybe latter version will be ok
      ;; (setq py-org-cycle-p t)

      ;; outline-magic is better than org-cycle, indeed
      ;; http://stackoverflow.com/a/4093889/173271?sgp=2
      ;; (define-key python-mode-map [backtab] 'outline-cycle)
      ;; (define-key outline-minor-mode-map [M-S-down] 'outline-move-subtree-down)
      ;; (define-key outline-minor-mode-map [M-S-up] 'outline-move-subtree-up)
    )
    (add-hook 'python-mode-hook 'my-python-hook)
  #+end_src

*** jedi
jedi 依赖 auto-complete. jedi-server 安装时要将 virtualenv2 软链为
virtualenv

jedi 的快捷键:
: C-c .
: C-c ,

#+name: 56091f33-28ce-43d6-bd64-c41bdc4f8959
#+BEGIN_SRC emacs-lisp
  (starter-kit-install-if-needed 'jedi)
  ;; (add-hook 'python-mode-hook 'jedi:setup)
  ;; (setq jedi:complete-on-dot t)                 ; optional
#+END_SRC

** 界面显示相关
*** 配色主题
[[http://emacsthemes.caisah.info/][这里]] 有很多主题的图示, 看花眼了. [[https://github.com/owainlewis/emacs-color-themes][这个]] 也不错, 以很多程序员的名字命名.

#+name: 5dcc9a75-85d3-4672-ab27-8b12686a61f0
#+BEGIN_SRC emacs-lisp
  (starter-kit-install-if-needed 'zenburn-theme)
  (starter-kit-install-if-needed 'smyx-theme)
  ;;(load-theme 'zenburn t)
  (load-theme 'smyx t)
  ;;(load-theme 'desert t)
  ;;(load-theme 'odersky t)
  ;; (load-file "~/.emacs.d/src/desert-theme.el" )
  ;; (load-file "~/.emacs.d/src/gwp-color-theme.el" )

#+END_SRC

#+RESULTS:
: t

* references
1. 可参考 sachac 的配置: [[https://github.com/sachac/.emacs.d][URL]]
2. 参考子龙山人的配置 [[https://github.com/zilongshanren/spacemacs-private][URL]]
3. Archlinux wiki [[https://wiki.archlinux.org/index.php/Spacemacs][URL]]
